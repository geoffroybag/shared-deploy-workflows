name: Deploy

on:
  workflow_call:
    inputs:
      pkg_name:
        required: true
        type: string
      preview_port:
        required: true
        type: string
    secrets:
      ssh_password:
        required: true

jobs:
  build:
    name: Deploy to server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Deploy over SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          command_timeout: 600s
          script: |
            export NVM_DIR=~/.nvm
            . ~/.nvm/nvm.sh
            cd websites/${{ inputs.pkg_name }}

            echo "Checking out main branch..."
            if ! git checkout main; then
              echo "::error::Failed to checkout 'main'"
              exit 1
            fi

            git reset --hard
            git clean -fd

            if ! git pull --rebase; then
              echo "::error::Git pull failed"
              exit 1
            fi

            npm install
            npm run build:preview

            pm2 delete ${{ inputs.pkg_name }} || true
            MODE=preview PORT=${{ inputs.preview_port }} pm2 start npm --name ${{ inputs.pkg_name }} -- run start
